services:
  squidward-node:
    container_name: squid-net-node
    restart: unless-stopped
    depends_on:
      - squidward-node-valkey
    build:
      context: .
      dockerfile: dev.Dockerfile
      args:
        - SQUID_VERSION=$SQUID_VERSION
        - LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL
        - DOMAIN=$DOMAIN
        - APP_PORT=$APP_PORT
        - CONTAINER_TZ=$TZ
    network_mode: host
    env_file:
      - .env
    mem_limit: 2048m
    ulimits:
      nproc: 1073741816
      nofile: 1048576
    volumes:
      - ./:/app
      - ./.data/certs:/etc/squid/certs
      - ./.data/.acme.sh:/root/.acme.sh
      - ./squid.dev.conf:/etc/squid/squid.conf
      - ./shell/docker-entrypoint.sh:/usr/local/bin/entrypoint.sh
    command:
      - npm start:dev


  squidward-node-valkey:
    image: valkey/valkey:9.0-alpine3.22
    container_name: squidward-node-valkey
    hostname: squidward-node-valkey
    restart: unless-stopped
    volumes:
      - squidward-node-valkey-vol:/data
    networks:
      squidward-node-internal:
      squidward-node-external: # DEV
    expose:
      - 6379
    ports: # DEV
      - "6380:6379"
    secrets:
      - valkey_password
    entrypoint: "/bin/sh -c \"valkey-server --requirepass $$(cat /run/secrets/valkey_password)\""

secrets:
  valkey_password:
    environment: REDIS_PASSWORD

networks:
  squidward-node-internal:
    name: squidward_node_internal
    internal: true
  squidward-node-external:
    name: squidward_node_external
    driver: bridge

volumes:
  squidward-node-valkey-vol:
    driver: local
    external: false
    name: squidward-node-valkey-vol