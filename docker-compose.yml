services:
  squidward-node:
    image: squidwardproxy/squidward-node:0.0.1
    restart: unless-stopped
    network_mode: host
    volumes:
      - squidward-node-certs-vol:/etc/squid/certs
      - squidward-node-acme-vol:/root/.acme.sh
      - ./.data/squid/logs:/var/log/squid
      - ./.data/squid/spool:/var/log/spool
    secrets:
      - letsencrypt_email
      - letsencrypt_email
    environment:
      - LETSENCRYPT_EMAIL=$$(cat /run/secrets/letsencrypt_email)
      - REDIS_PASSWORD=$$(cat /run/secrets/valkey_password)

  squidward-redis:
    image: valkey/valkey:9.0-alpine3.22
    container_name: squidward-node-valkey
    hostname: squidward-node-valkey
    restart: unless-stopped
    volumes:
      - squidward-node-valkey-vol:/data
    network_mode: host
    secrets:
      - valkey_password
    entrypoint: "/bin/sh -c \"valkey-server --requirepass $$(cat /run/secrets/valkey_password)\""

secrets:
  valkey_password:
    environment: REDIS_PASSWORD
  letsencrypt_email:
    environment: LETSENCRYPT_EMAIL

volumes:
  squidward-node-certs-vol:
    driver: local
    external: false
    name: squidward-node-certs-vol
  squidward-node-acme-vol:
    driver: local
    external: false
    name: squidward-node-acme-vol
  squidward-node-valkey-vol:
    driver: local
    external: false
    name: squidward-node-valkey-vol